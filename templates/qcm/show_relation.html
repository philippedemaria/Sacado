{% extends 'dashboard.html' %}
{% load static %}
{% load widget_tweaks %}
{% load item_tags %}
 
{% block page_title %}
 <a href="{% url 'show_parcours_student' relation.parcours.id %}" style="color:{{ parcours.color }}">
  <i class="fa fa-desktop"></i> {{ relation.parcours }}
  </a> <img src="{% static 'img/angle-right.png' %}"/> 
  <small> {{ relation.exercise.knowledge.name }}</small>
{% endblock %}

{% block page_menu_right %}
 
{% endblock %}


{% block require %}
  <script src="{% static 'js/require.js' %}" data-main="{% static 'js/common3.js' %}"></script>  
  <script>
     require(['script/ajax-score']);
  </script>  
{% endblock %} 

{% block body  %}  
<section class="content_main content_main_exercise">
    {% get_available relation student  as available %} <!-- Si le nombre de tentative est dépassée ou pas -->
    {% get_parcours_available parcours student relation.exercise as parcours_available %} <!-- Si le nombre de tentative est dépassée ou pas -->
    <div class="col-sm-0 col-md-1 col-lg-1 full_screen_size">
        <div class="calculator double_bottom_padding">
        {% if relation.exercise.supportfile.calculator %}
          <img src="{% static 'img/calculator.png' %}"  class="img_size_square_75" />
        {% else %}
          <img src="{% static 'img/no_calculator.png' %}"    class="img_size_square_75" />
        {% endif  %} 
        </div>
        <div class="horloge">
            {% if relation.duration == 5 %}
              <img src="{% static 'img/horloge5.png' %}"   class="img_size_square_75" />
            {% elif relation.duration == 10 %}
              <img src="{% static 'img/horloge10.png' %}"   class="img_size_square_75" />
            {% elif relation.duration == 15 %}
              <img src="{% static 'img/horloge15.png' %}"   class="img_size_square_75" />
            {% elif relation.duration == 20 %}
              <img src="{% static 'img/horloge20.png' %}"   class="img_size_square_75"  />
            {% elif relation.duration == 25 %}
              <img src="{% static 'img/horloge25.png' %}"   class="img_size_square_75"  />
            {% elif relation.duration == 30 %}
              <img src="{% static 'img/horloge30.png' %}"   class="img_size_square_75" />
            {% elif relation.duration == 35 %}
              <img src="{% static 'img/horloge35.png' %}"    class="img_size_square_75" />
            {% elif relation.duration == 40 %}
              <img src="{% static 'img/horloge40.png' %}"   class="img_size_square_75"/>
            {% elif relation.duration == 45 %}
              <img src="{% static 'img/horloge45.png' %}"    class="img_size_square_75" />
            {% elif relation.duration == 50 %}
              <img src="{% static 'img/horloge50.png' %}"   class="img_size_square_75" />
            {% elif relation.duration == 55 %}
              <img src="{% static 'img/horloge55.png' %}"   class="img_size_square_75" />
            {% elif relation.duration == 60 %}
              <img src="{% static 'img/horloge60.png' %}"   class="img_size_square_75" />
            {% else %}
              <img src="{% static 'img/horloge15.png' %}"   class="img_size_square_75" />
            {% endif  %} 
            <p> {{ relation.duration }} minute{{ relation.duration|pluralize }}</p>
        </div>
        <div class="situation">
            <img src="{% static 'img/situation.png' %}"  class="img_size_square_75" />
            <p>{{ relation.situation }} question{{ relation.situation|pluralize }}</p>
        </div>
        <div class="situation" > 
        {% if  parcours.maxexo > -1 %}
                <div class="available">
                    <b> {{ parcours_available.nbleft }}</b>  
                </div>
                <p>Tentative{{ parcours_available.nbleft|pluralize  }} restante{{ parcours_available.nbleft|pluralize  }}</p>
        {% else %}
            {% if  relation.maxexo > -1 %}

                <div class="available">
                    <b> {{ available.nbleft }}</b>  
                </div>
                <p>Tentative{{ available.nbleft|pluralize  }} restante{{ available.nbleft|pluralize  }}</p>
            {% else  %} 
                <div class="available_infinite" > 
                    <b> $ \infty $</b>  
                </div>
                <p>Tentatives restantes</p>
            {% endif  %} 
        {% endif %}


        </div>

        <div class="barcode">
            <i class="fa fa-barcode fa-4x"></i>
            <p>{{ relation.exercise.supportfile.code }}</p>
        </div>
    </div>  
    <div class="col-sm-10 col-md-8 col-lg-8">



      {% for remediation in relation.relationship_remediation.all %}

          {% if remediation.consigne %}
          <audio controls>
              <source src="{{ remediation.mediation.url }}" type="audio/mpeg">
              <span class="text-danger">Votre navigateur ne lit pas l'audio.</span>
          </audio>
          {% endif %}

      {% endfor  %} 


      <form action="{% url 'store_the_score_relation_ajax'  %}" method="POST" enctype='multipart/form-data'>   
        {% csrf_token %}  


          <div class='justify-content-center'  style="position:relative">



              {% if parcours.is_evaluation %}
                   
 
                  <div class="alert alert-danger" style="width:750px; position:absolute;z-index: 999;"  role="alert" id="message_alerte">
                      Cet exercice est proposé dans une <b>évaluation</b>. Vous devez répondre à exactement <b>{{ relation.situation }} question{{ relation.situation|pluralize  }}</b>. <small><em>Cliquez sur la croix pour faire disparaitre ce bandeau  </em></small><i class="fas fa-long-arrow-alt-right"></i> 
                      <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                  </div> 
 
              {% endif %}





              <div id="preload_div">
                  <div id="preload"></div>
                  Chargement...
              </div>



              <div class='justify-content-center' id="show_ggb"  >
                  <div style="position:absolute;bottom:80px;font-size: 12px;width:50px;color:#0d72ac;left:780px;">
                      Mode plein <br> écran <br>
                      <img src="{% static 'img/flechebleue.png' %}" style="position:absolute; right:30px;"/>            
                  </div>


                
                  <div class = 'col-auto' id='ggb_applet_container' ></div>
              </div>


 
          </div>

       
                  <div class="form-group">  
                    {% if user.user_type == 0 %}

                        {% get_is_lock parcours today as is_lock %} 
                        {% get_is_locker relation student as is_locker %} 

                        {% if is_lock %}
                        
                            {% if is_locker %}
                              <div class="alert alert-danger" >
                                <b>Cet exercice est verrouillé. Vous ne pouvez plus soumettre le résultat.</b>
                              </div>

                            {% else %}

                                {% include 'qcm/is_evaluation.html' %}


                            {% endif %}

                        {% else %}  


                            {% if available.is_ok %}

 
                                {% include 'qcm/is_evaluation.html' %}

                            {% else %}
                              <div class="alert alert-danger" >
                                <b>Vous avez atteint la limite des tentatives. Vous ne pouvez plus soumettre le résultat.</b>
                              </div>
                            {% endif %}


                        {% endif %}

                    {% endif %}  


                    {% if parcours.is_evaluation %}

                        {% if  parcours.is_exit %}
                          <a href="{% url 'show_parcours_student' parcours.id %}"  class="btn btn-default" >  Revenir aux exercices   </a>
                        {% endif %}

                    {% else %}
                      <a href="javascript:history.back()"><input type="button" value="Revenir aux exercices" class="btn btn-default "/></a>
                    {% endif %}

                      <!-- ligne d'enregistrement -->
                      <input id="relation" name="relation_id"  type="hidden" value="{{ relation.id }}"/>
                      <input id="start_time" name="start_time"  type="hidden" value="{{ start_time }}"/>
                      <input id="numexo" name="numexo" type="hidden"  />
                      <input id="score" name="score" type="hidden"  />
                      <input id="situation" name="situation"  type="hidden" value="{{ relation.situation }}"/> 
                      <!-- fin ligne d'enregistrement -->


                  </div>
            
      </form>
    </div> 
    <div class="col-sm-2 col-md-1 col-lg-1">

      {% if relation.relationship_remediation.all|length > 0 %}
      <h1 class="thin">Aides</h1>
         {% for remediation in relation.relationship_remediation.all %}
              <a href="#" data-target="#remediation_viewer" data-remediation_id="{{ remediation.id }}" data-is_custom="0"  data-url="0" data-toggle='modal' class="white remediation_viewer btn btn-default full_width">
                  {% include 'qcm/remediation_choices.html' %}
              </a><br/><br/>
          {% endfor  %} 
      {% endif  %}
    </div>
    <div class="col-sm-12 col-md-2 col-lg-2">
        {% if not relation.parcours.is_evaluation %}
        {% if relation.relationships_courses.all|length > 0 %}      
          <h4 style="color:{{ relation.parcours.color }}">Le cours </h4>
          <ul class="nav nav-pills nav-stacked admin-menu">
              {% for course in relation.relationships_courses.all %}
                  <li class="{% if forloop.first %}active{% endif %} menu_course">
                      <a href="#" data-toggle='modal' data-target='#menu_course{{ forloop.counter }}'  data-relation_id='{{ relation.id }}' class="header_shower"> {{ course.title }}</a> 
                      <div class="modal fade" id="menu_course{{ forloop.counter }}" tabindex="-1" role="dialog" aria-labelledby="menu_course{{ forloop.counter }}">
                          <div class="modal-dialog" role="document"  style="width:95%;color:#000">
                              <div class="modal-content" style="padding-top :0px;">
                                  <div class="modal-header">
                                      <h3>{{ course.title }}
                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <span aria-hidden="true">&times;</span>
                                      </button> 
                                      </h3>
                                  </div>
                                  <div class="modal-body">
                                      <div class="row">
                                          <div class="col-lg-12 col-xs-12">   
                                              {{ course.annoncement|safe }}
                                          </div>   
                                      </div> 
                                  </div>
                              </div>
                          </div>
                      </div>
                  </li>
              {% endfor %}

          </ul>
          <hr/>
        {% endif %}    
        {% endif %}  




              <div class="row">
                  <div class="col-lg-12 col-xs-12"> 
                    <div class="form-group"> 
                        <a href="#" id='error_set' class="pull-right btn btn-warning" >Signaler <span class="label_plus"> un problème sur cet exercice</span> ? </a>
                    </div>
                 </div>                     
              </div> 
              <div class="row">
                  <div class="col-lg-12 col-xs-12"> 
                    <div class="form-group" id='form_error_set'> 
                        <form action="" method="POST">    {% csrf_token %}
                            <div class="form-group">
                                <textarea name="message" id="message"   class="form-control" placeholder="Vous devez décrire le problème brièvement. Merci."></textarea>
                            </div>
                            <div class="row">
                                <div class="col-lg-12 col-xs-12">   
                                    <div class="form-group">
                                        <a id="error_sender" data-from ="0" data-exercise_id="{{ exercise.id }}" class="pull-right btn btn-warning">Signaler</a>
                                    </div>
                                </div>  
                                <div class="col-lg-12 col-xs-12">   
                                    <div class="verif_sender">
                                    </div>
                                </div>  
                            </div> 
                        </form>
                    </div>
                 </div>                     
            </div> 
    </div>  












    <script type="text/javascript" src="{% static 'js/lib/geogebra.js' %}"></script>
                  <!-- Additional Javascript for Geogebra exercises -->
    <!-- <script type="text/javascript" src="https://cdn.geogebra.org/apps/deployggb.js"></script> -->
    <script type="text/javascript">
          // parameters of the geogebra app

        var width               = "{{ exercise.supportfile.width }}" ;
        var height              = "{{ exercise.supportfile.height }}" ; 
        var showToolBar         = "{{ exercise.supportfile.toolBar|lower }}" ;
        var showMenuBar         = "{{ exercise.supportfile.menuBar|lower }}" ;
        var showAlgebraInput    = "{{ exercise.supportfile.algebraInput|lower }}" ;
        var showResetIcon       = "{{ exercise.supportfile.resetIcon|lower }}" ; 
        var enableShiftDragZoom = "{{ exercise.supportfile.dragZoom|lower }}" ;
        var filename            = "{{ exercise.supportfile.ggbfile.url }}" ;



        var parameters = {
              "appname":"classic",
              "id":"ggb_applet_container",
              "prerelease":false,
              "width": parseInt(width, 10),
              "height": parseInt(height, 10),
              "showToolBar": showToolBar,
              "showfullscreenbutton":true,
              "borderColor":"#f5f8fd",
              "showMenuBar": showMenuBar,
              "showAlgebraInput": showAlgebraInput ,
              "showResetIcon": showResetIcon ,
              "enableLabelDrags":false,
              "enableShiftDragZoom": enableShiftDragZoom,
              "enableRightClick":false,
              "capturingThreshold":null,
              "showToolBarHelp":false,
              "errorDialogsActive":false,
              "useBrowserForJS":false,
              "langage":"en",
              "filename": filename,
               "appletOnLoad" :  function(applet) { 
                        var situation = "{{ relation.situation }}" ;
                        applet.setValue("situation", situation );

                    {% if parcours.is_evaluation and parcours.is_stop %}
                       applet.registerUpdateListener("updateListener");  
                    {% endif %}

                  }
              };



              function updateListener(objName) {
                  var applet = document.ggbApplet;
                    if ( objName == "fini") { 
                        if ( applet.getValue(objName)  ==  1 ) { 

                          alert("Vous êtes en évaluation. L'exercice est fini. Vous devez enregistrer votre résultat.") ;
                          applet.setValue("fini", 0) ; 

                        }
                    }
                }


        var applet = new GGBApplet('5.0', parameters,true);
        // Geogebra applet creation
        applet.inject('ggb_applet_container', 'preferHTML5');  

    </script>
    <div style="height:20px"></div>

</section>


{% endblock  %}   

 
