<!DOCTYPE html>
<html>
  <head>

        <style type="text/css" media="screen">
div#fenEditeur { 
    width:500px;
    height:400px;
    display:inline-block;
    }

#editor {d
    width: inherit  ;
    height : inherit;
}
div#fenConsole { 
    width:500px;
    height:400px;}
button[class*="bouton-"] {
  border: none;
  width:180px;
  border-radius:10px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
}

.bouton-echec {
  background-color: #FFA0A0; }
  
.bouton-neutre {
  background-color: #B0B0B0; 
}
.bouton-succes {
  background-color: #4CAF50; 
}

	
    </style>
<script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.4/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.4/ext-static_highlight.js"></script>

  </head>
  <body>

 
  <div><h3>Consigne</h3>
     {{ instruction }}
   </div>
   <div><h3>Solution</h3>
     <pre>{{ prog_cor | safe }}  </pre>
   </div>
   <div><h3>Jeu de tests</h3>
     <pre>{{ autotest | safe }}</pre>
   </div>
   
  
<div id="fenEditeur", style="float:left"><pre id="editor">{{ preambule_visible }}</pre>
</div>
<div id="fenConsole" style="float:left"><textarea id="output" style="width:100%;height:100%;" onkeypress="lireconsole"></textarea>
</div>
 <div style="clear:both;">
	 <br><br>
	<button class="bouton-neutre" onclick="evalue()">Éxecuter</button>
	<button id="teste" class="bouton-neutre" onclick="teste()">Tester</button>
	
</div>
    <script>
      const output = document.getElementById("output");
      const bouton = document.getElementById("teste");

      function addToOutput(s) {
          //output.value += ">>>" + code.value + "\n" + s + "\n";
	  output.value += "\n"+ s + "\n>>>";
	  output.scrollTop=output.scrollHeight;
      }

      output.value = "Initializing...\n";
      // init Pyodide
      async function main() {
        let pyodide = await loadPyodide();
          output.value += "Ready!\n";
	  //console.logs=[];
	  //output.value += pyodide.runPython("import sys ; print(sys.version)");
	  //addToOutput(console.logs.join("\n"));
	  output.value+="prêt\n>>>"
        return pyodide;
      }
    let pyodideReadyPromise = main();

     async function evalue(c=editor.getValue()) {
          let pyodide = await pyodideReadyPromise;
	  console.logs=[];
        try {
            let output = pyodide.runPython(c);
            addToOutput(console.logs.join("\n"));
        } catch (err) {
            addToOutput(err);
	
        }
      }
async function teste() {
	let pyodide = await pyodideReadyPromise;
	console.logs=[];
    try {
	   let output = pyodide.runPython(editor.getValue()+'\n'+`{{autotest | safe }}`);
       sortieEleve=console.logs.join("\n");
       console.log("resultat eleve : ",sortieEleve);
       } 
     catch (err) {
            addToOutput(err);
	         return false}
	
	 console.logs=[];
	 sortieAttendue="";
     try {
	   let output = pyodide.runPython(`{{ prog_cor | safe}}`+"\n"+`{{ autotest | safe}}`);
       sortieAttendue=console.logs.join("\n");
       console.log("resultat correct : ",sortieAttendue);
 
       } 
     catch (err) {
            addToOutput("**** problème avec le programme de test\n"+err);
	         return false }
	  console.log(sortieEleve,sortieAttendue);
	  ok=(sortieEleve==sortieAttendue);
	  console.log("egalité ? ",ok);
	
	  if (ok) {bouton.className="bouton-succes"; bouton.innerHTML="Succès !";}
	else   {bouton.className="bouton-echec"; bouton.innerHTML="Echec ! recommencez";}
		  
	  return ok;
  }
    function configEditor(){
                // configure the ace editor to make it usable
                editor = ace.edit("editor");
                editor.setTheme("ace/theme/monokai");
                editor.session.setMode("ace/mode/python");
                editor.setShowPrintMargin(false);
                editor.setBehavioursEnabled(true);
                editor.setFontSize(18);
            }      
    document.addEventListener('DOMContentLoaded', (event) => {
     
                // Capture the output from Pyodide and add it to an array
                console.stdlog = console.log.bind(console);
                console.logs = [];
                console.log = function(){
                    console.logs.push(Array.from(arguments));
                    console.stdlog.apply(console, arguments);
                }
                 configEditor();
                 editor.setValue("{{ preambule_visible | safe}}\n")
                 evalue("{{preambule_cache | safe }}");
                  
                
    });

      
    </script>
  </body>
</html>
